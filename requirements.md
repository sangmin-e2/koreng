# IME Caret Indicator (E Badge) - requirements.md

## 1. 프로젝트 개요
Windows에서 한/영 전환 실수로 인한 재입력 스트레스를 줄이기 위해,
현재 텍스트 입력 위치(캐럿, caret) 근처에 **입력 언어 상태를 직관적으로 표시**하는 경량 오버레이 앱을 개발한다.

사용자는 타이핑 중인 지점 바로 옆에서 상태를 확인하여
"한참 치고 다시 쳐야 하는" 상황을 최소화한다.

---

## 2. 핵심 목표(절대 요구사항)
1) **캐럿(텍스트 입력 위치) 옆에 원형 배지(동그라미)가 나타나야 한다.**
2) 원형 배지 안에 **작게 'E' 문자가 표시**되어야 한다(영어 상태 표시).
3) 사용자가 혼동하지 않도록, **언어 상태 때문에 배지가 사라지면 안 된다.**
   - 즉, 한글 상태라고 해서 배지를 숨기지 않는다.
4) 배지가 사라지는 경우는 오직 아래 두 가지뿐이다.
   - (a) 사용자가 **프로그램을 종료했을 때**
   - (b) 현재 포커스가 **텍스트 입력 중이 아니어서 캐럿이 존재하지 않을 때**(예: 바탕화면, 파일탐색기 리스트 등)
5) 앱은 항상 사용자의 입력을 방해하지 않아야 한다.
   - 클릭/포커스 탈취 금지
   - 타이핑 흐름을 끊지 않음

---

## 3. 동작 정의(언어 표시 규칙)
### 3.1 표시 형태
- 배지 형태: 작은 원형(동그라미) 오버레이
- 배지 내부 텍스트:
  - 영어 입력 상태: **"E"**
  - 한글 입력 상태: **"가"** (또는 설정값으로 "K"로 대체 가능; 기본은 "가")

### 3.2 색상 규칙(기본값)
- 영어 입력 상태: 초록 배지 + 흰색 텍스트
- 한글 입력 상태: 주황 배지 + 흰색 텍스트

### 3.3 위치 규칙
- 배지는 **현재 캐럿 화면 좌표 기준으로 약간 오른쪽/아래**에 배치한다.
- 기본 오프셋:
  - X: +6px
  - Y: +10px
- 사용자 환경(모니터 배율, 앱 폰트 등)에 따라 오프셋/크기 조정 가능해야 한다(설정값).

---

## 4. 기능 요구사항 (Functional Requirements)

### FR-1: 캐럿 위치 추적
- 현재 포커스된 윈도우의 GUI 스레드에서 캐럿 위치(rcCaret)를 획득한다.
- 캐럿 좌표는 클라이언트 좌표계일 수 있으므로 화면 좌표(Screen)로 변환한다.
- 캐럿이 없으면(입력 상태 아님) 배지를 숨긴다.

### FR-2: IME(한/영) 상태 판별
- 한국어(ko-KR) 키보드 레이아웃인 경우:
  - IME OpenStatus 기반으로 한글/영어 상태를 판별한다.
- 한국어 레이아웃이 아닌 경우:
  - 기본적으로 영어 상태로 취급한다(배지: 초록 + "E").

### FR-3: 표시 업데이트 루프
- 배지 위치/내용은 **주기적으로 갱신**되어야 한다.
- 갱신 주기 권장:
  - 80ms ~ 120ms (성능/부드러움 균형)
- 갱신은 사용자 타이핑을 방해하지 않도록 백그라운드에서 수행한다.

### FR-4: 항상 위(Topmost) 오버레이
- 배지는 항상 다른 창 위에 보이도록 Topmost 속성을 유지한다.

### FR-5: 클릭/포커스 방해 금지 (Click-through + No-activate)
- 배지는 마우스 클릭을 먹지 않아야 한다(클릭-스루).
- 배지 창이 포커스를 빼앗지 않아야 한다(No-activate).
- 사용자가 텍스트 입력 중일 때 앱 존재가 "없는 것처럼" 동작해야 한다.

### FR-6: 종료 시 완전 비활성화
- 사용자가 프로그램을 종료하면 배지가 즉시 사라지고 기능이 완전히 중지되어야 한다.
- 언어 상태에 따라 사라지는 일이 없어야 하며,
  **오직 프로그램 종료(또는 캐럿 미존재)일 때만 사라져야 한다.**

---

## 5. UI/UX 요구사항

### UX-1: 직관성
- 영어일 때: 원 안의 "E"를 통해 즉시 인지 가능해야 한다.
- 한글일 때: "가"(또는 K)로 즉시 인지 가능해야 한다.
- 사용자가 "지금 앱이 꺼진 건지, 한글이라 안 보이는 건지" 헷갈리지 않도록,
  **언어 상태로 숨김 처리 금지**.

### UX-2: 최소 방해
- 크기는 작지만 인지 가능한 수준(기본 18px 내외).
- 투명 배경(원형 배지만 보이도록).
- 입력 커서 근처에서만 표시되어 시선 이동 최소화.

---

## 6. 기술 요구사항 (Technical Requirements)

### TR-1: OS 지원
- Windows 10/11 지원(우선 Windows 11 기준).

### TR-2: 구현 언어 및 라이브러리
- 구현 언어: **Python**
- UI: tkinter (투명 배경 오버레이)
- Windows API 호출: ctypes
- IME 상태: imm32 (ImmGetContext, ImmGetOpenStatus 등)
- 캐럿 정보: user32 (GetGUIThreadInfo, ClientToScreen 등)

### TR-3: 성능
- CPU 점유율이 유휴 상태에서 낮아야 한다(경량).
- 업데이트 루프는 과도한 리소스 사용을 피한다.

### TR-4: 배율(DPI) & 멀티모니터
- 모니터 배율(125%, 150%, 200%)에서 위치 오차가 발생할 수 있으므로,
  최소한 설정 오프셋으로 보정 가능해야 한다.
- 멀티 모니터 환경에서 화면 좌표가 정상 동작해야 한다.

### TR-5: 권한/제약사항 고지
- 관리자 권한으로 실행된 앱(예: 관리자 CMD) 위에서는
  일반 권한 오버레이가 캐럿 정보를 못 읽을 수 있다.
- 위 경우 동작 제한 가능성을 문서화한다(에러 없이 조용히 숨김).

### TR-6: 네트워크/개인정보
- 네트워크 통신 없음.
- 키 입력 내용 저장/전송 없음.
- 포커스/캐럿 위치 정보는 표시 목적의 메모리 내 처리만 수행.

---

## 7. 배포/패키징 요구사항

### PKG-1: 실행 방식
- 개발 실행: python 단독 실행 가능해야 함.
- 배포: Windows용 **단일 exe** 생성 가능해야 함.

### PKG-2: 패키징 도구
- PyInstaller 사용:
  - 콘솔 없이 실행 옵션 제공(기본: --noconsole)
  - 단일 파일(Onefile) 옵션 제공

### PKG-3: 종료 방법(최소 요구)
- 기본: 실행한 프로세스를 종료하면 완전 종료됨.
- (선택/추가) 트레이 아이콘 우클릭 → 종료 기능 제공 가능.

---

## 8. 설정(옵션) 요구사항 (가능하면 포함)
- 배지 크기(DOT_SIZE)
- 오프셋(OFFSET_X, OFFSET_Y)
- 한글 표시 텍스트("가" ↔ "K")
- 색상(ENG/KOR fill, text color)
- 업데이트 주기(ms)

설정 파일(ini/json) 또는 코드 상단 상수로 관리 가능.

---

## 9. 테스트/검증 시나리오 (Acceptance Tests)

### AT-1: 기본 표시
- 메모장/브라우저 주소창 등 텍스트 입력 중:
  - 캐럿 옆에 원형 배지가 항상 보인다.

### AT-2: 언어 전환 반영
- 한/영 전환 시 0.2초 이내로 배지가 즉시 변경된다.
  - 영어: 초록 + "E"
  - 한글: 주황 + "가"(또는 K)

### AT-3: 언어 때문에 숨김 금지
- 한글 상태에서도 배지가 사라지지 않는다.
- 배지가 사라지는 유일 조건은:
  - 캐럿이 없는 상태
  - 프로그램 종료

### AT-4: 입력 방해 없음
- 배지 위를 클릭해도 입력 포커스가 바뀌지 않는다.
- 배지가 입력을 먹거나 커서 이동을 방해하지 않는다.

### AT-5: 캐럿 없음 처리
- 바탕화면/파일탐색기(입력칸 아닌 곳)에서는 배지가 숨는다.

### AT-6: 종료 확인
- 프로그램 종료 즉시 배지가 사라지고 재등장하지 않는다.

---

## 10. 범위 제외(Out of Scope)
- 다른 앱의 "캐럿 자체 색상"을 직접 변경하는 기능 (Windows 구조상 일반적으로 불가/비권장)
- 키보드 입력을 가로채거나 자동 변환해주는 기능(보안/호환성 리스크)
- OCR 기반 상태 판별(비용/지연/오탐 증가)

---

## 11. 향후 개선 아이디어(선택)
- 트레이 아이콘(실행/종료/설정)
- 시작프로그램 등록 옵션
- DPI 자동 보정(Per-monitor DPI aware)
- 예외 앱(보안 브라우저 등)에서의 graceful fallback 표시
